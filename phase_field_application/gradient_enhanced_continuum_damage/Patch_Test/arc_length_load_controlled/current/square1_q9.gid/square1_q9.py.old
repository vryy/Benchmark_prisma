##################################################################
##### ekate - Enhanced KRATOS for Advanced Tunnel Enineering #####
#####  copyright (c) (2009, 2010, 2011, 2012, 2013)          #####
#####   by CIMNE, Barcelona, Spain and Janosch Stascheit     #####
#####           for TUNCONSTRUCT                             #####
#####  and (c) 2014, 2015, 2016, 2017, 2018, 2019, 2020,     #####
#####     2021, 2022 by Hoang-Giang Bui for SFB837           #####
##### all rights reserved                                    #####
##################################################################
##################################################################
## This file is generated on Mi 9. Mar 11:25:54 CET 2022 
##################################################################
import sys
import os
import math
import time as time_module
##################################################################
##################################################################
sys.path.append('./square1_q9.gid')
import square1_q9_include
from square1_q9_include import *
# calculate insitu-stress for geology_virgin.gid
model = square1_q9_include.Model('square1_q9',os.getcwd()+"/",os.getcwd()+"/")
model.InitializeModel()
##################################################################
###  SIMULATION  #################################################
start_time = time_module.time()
##################################################################

## boundary condition
tol = 1.0e-6
load_nodes = []
for node in model.model_part.Nodes:
    if abs(node.X0) < tol:
        node.Fix(DISPLACEMENT_X)
    if abs(node.Y0) < tol:
        node.Fix(DISPLACEMENT_Y)

def SetLoad(model_part, lmbda):
    for node in model.model_part.Nodes:
        if abs(node.X0 - 1.0) < tol:
            node.SetSolutionStepValue(FACE_LOAD_X, lmbda*1.0e1)
            node.SetSolutionStepValue(FACE_LOAD_Y, 0.0)

model.solver.solver.set_load_callback = SetLoad

ifile = open("results_damage.txt", "w")
ifile.write("step\tdisp\tdamage\n")

ifile2 = open("results_reaction.txt", "w")
ifile2.write("step\tdisp\treaction\n")

time = 0
model.SolveModel(time)
# sys.exit(0)

ifile.write("0\t0.0\t0.0\n")
ifile2.write("0\t0.0\t0.0\n")

## loading
delta_time = 1.0
step = 0

step_list = []
step_list.append([2, 9.0e-5])
step_list.append([4, 5.0e-6])
step_list.append([30, 4.0e-6])
for tmp in step_list:
    nsteps = tmp[0]
    model.solver.solver.arc_length_control_process.GetConstraint().SetRadius(tmp[1])
    for i in range(0, nsteps):
        print("Load step " + str(step + 1) + " starts")
        time += delta_time
        model.SolveModel(time)
        # model.WriteOutput(time)
        print("Load step " + str(step + 1) + " completed")

        disp = model.model_part.Nodes[9].GetSolutionStepValue(DISPLACEMENT_X)
        damage = model.model_part.Elements[1].CalculateOnIntegrationPoints(DAMAGE, model.model_part.ProcessInfo)
        ifile.write(str(step+1) + "\t" + str(disp) + "\t" + str(damage[0][0]) + "\n")
        ifile.flush()

        ifile2.write(str(step+1) + "\t" + str(disp) + "\t" + str(model.model_part.Nodes[1].GetSolutionStepValue(REACTION_X)) + "\n")
        ifile2.flush()

        step += 1

## unloading
lambda_current = model.solver.solver.arc_length_control_process.GetLambda()
print("Lambda at the end of loading: " + str(lambda_current))
delta_lambda = -lambda_current / 100.0
model.solver.solver.DeactivateArcLengthControl() # deactivate arc-length, load is user-controlled
for i in range(0, 50):
    lambda_current += delta_lambda
    SetLoad(model.model_part, lambda_current)
    model.solver.solver.arc_length_control_process.Update(delta_lambda)

    print("Unload step " + str(step + 1) + " starts")
    time += delta_time
    model.SolveModel(time)
    # model.WriteOutput(time)
    print("Unload step " + str(step + 1) + " completed")

    disp = model.model_part.Nodes[9].GetSolutionStepValue(DISPLACEMENT_X)
    damage = model.model_part.Elements[1].CalculateOnIntegrationPoints(DAMAGE, model.model_part.ProcessInfo)
    ifile.write(str(step+1) + "\t" + str(disp) + "\t" + str(damage[0][0]) + "\n")
    ifile.flush()

    ifile2.write(str(step+1) + "\t" + str(disp) + "\t" + str(model.model_part.Nodes[1].GetSolutionStepValue(REACTION_X)) + "\n")
    ifile2.flush()

    step += 1

lambda_current = model.solver.solver.arc_length_control_process.GetLambda()
print("Lambda at the end of unloading: " + str(lambda_current))

## reloading
step_list = []
step_list.append([100, 4.0e-6])
model.solver.solver.ActivateArcLengthControl()
first_reload = True
for tmp in step_list:
    nsteps = tmp[0]
    model.solver.solver.arc_length_control_process.GetConstraint().SetRadius(tmp[1])
    for i in range(0, nsteps):
        if first_reload:
            model.solver.solver.arc_length_control_process.SetForcedForward(True)
            first_reload = False
        else:
            model.solver.solver.arc_length_control_process.SetForcedForward(False)

        print("Reload step " + str(step + 1) + " starts")
        time += delta_time
        model.SolveModel(time)
        # model.WriteOutput(time)
        print("Reload step " + str(step + 1) + " completed")

        disp = model.model_part.Nodes[9].GetSolutionStepValue(DISPLACEMENT_X)
        damage = model.model_part.Elements[1].CalculateOnIntegrationPoints(DAMAGE, model.model_part.ProcessInfo)
        ifile.write(str(step+1) + "\t" + str(disp) + "\t" + str(damage[0][0]) + "\n")
        ifile.flush()

        ifile2.write(str(step+1) + "\t" + str(disp) + "\t" + str(model.model_part.Nodes[1].GetSolutionStepValue(REACTION_X)) + "\n")
        ifile2.flush()

        step += 1

lambda_current = model.solver.solver.arc_length_control_process.GetLambda()
print("Lambda at the end of reloading: " + str(lambda_current))

ifile.close()
ifile2.close()

##################################################################
###  END OF SIMULATION  ##########################################
end_time = time_module.time()
print("Calculation time: " + str(end_time - start_time) + " s")
timer = Timer()
print(timer)
##################################################################
