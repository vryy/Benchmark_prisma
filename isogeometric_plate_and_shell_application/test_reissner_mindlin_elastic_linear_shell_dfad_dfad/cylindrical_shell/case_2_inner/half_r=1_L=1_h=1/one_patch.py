import sys
import os
import numpy as np

sys.path.append(os.getcwd() + "/..")
import simulation_include
import KratosMultiphysics
from KratosMultiphysics.MKLSolversApplication import *
from KratosMultiphysics.ExternalSolversApplication import *

sys.path.append(os.environ['HOME'] + "/kratos_bundle/Benchmark_kratos/python3/plate_and_shell_application/test_reissner_mindlin_elastic_linear_shell_dfad_dfad/cylindrical_shell")
import analytical_solution

E = 2.6
nu = 0.3
L = 1.0
R = 1.0
h = 1.0
p = 1.0
if KratosMKLSolversApplication.Has("MKLPardisoSolver"):
    plinear_solver = MKLPardisoSolver()
else:
    plinear_solver = SuperLUSolver()
drill_stiff = 1e-3 # set drill stiff to 0 to have optimal convergence

def test():
    l2_error_list = convergence(n=4, logging = False)

    assert(abs(l2_error_list[0] - 1.706421e-02) < 1e-5)
    assert(abs(l2_error_list[1] - 8.344745e-04) < 1e-5)
    assert(abs(l2_error_list[2] - 7.074857e-05) < 1e-5)
    assert(abs(l2_error_list[3] - 9.685896e-06) < 1e-5)

    print("Test passed")

def test1():
    disp = {}
    disp[1] = [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00]
    disp[2] = [0.0000000000000000e+00, 6.8820225426258711e-03, 5.7237719097157688e-03]
    disp[3] = [0.0000000000000000e+00, 2.0858246606846625e-02, 1.9979840192508452e-02]
    disp[4] = [0.0000000000000000e+00, 4.0788757131876616e-02, 4.9275412797745305e-02]
    disp[5] = [0.0000000000000000e+00, 5.8915274727815735e-02, 8.7562202953284193e-02]
    disp[6] = [0.0000000000000000e+00, 7.3384996509378936e-02, 1.3435935809053387e-01]
    disp[7] = [0.0000000000000000e+00, 8.2067698359605007e-02, 1.8786402047433268e-01]
    disp[8] = [0.0000000000000000e+00, 8.2892902673746743e-02, 2.4458199294873428e-01]
    disp[9] = [0.0000000000000000e+00, 7.4399600828046267e-02, 2.9926324446379721e-01]
    disp[10] = [0.0000000000000000e+00, 5.6395580009698583e-02, 3.4540287030767369e-01]
    disp[11] = [0.0000000000000000e+00, 3.0466654636914378e-02, 3.7643580610070643e-01]
    disp[12] = [0.0000000000000000e+00, 1.3764454036386774e-16, 3.8739937734349744e-01]
    disp[13] = [0.0000000000000000e+00, -3.0466654636914135e-02, 3.7643580610070654e-01]
    disp[14] = [0.0000000000000000e+00, -5.6395580009698423e-02, 3.4540287030767386e-01]
    disp[15] = [0.0000000000000000e+00, -7.4399600828046128e-02, 2.9926324446379726e-01]
    disp[16] = [0.0000000000000000e+00, -8.2892902673746674e-02, 2.4458199294873442e-01]
    disp[17] = [0.0000000000000000e+00, -8.2067698359604924e-02, 1.8786402047433245e-01]
    disp[18] = [0.0000000000000000e+00, -7.3384996509378866e-02, 1.3435935809053387e-01]
    disp[19] = [0.0000000000000000e+00, -5.8915274727815707e-02, 8.7562202953284138e-02]
    disp[20] = [0.0000000000000000e+00, -4.0788757131876588e-02, 4.9275412797745319e-02]
    disp[21] = [0.0000000000000000e+00, -2.0858246606846608e-02, 1.9979840192508452e-02]
    disp[22] = [0.0000000000000000e+00, -6.8820225426258659e-03, 5.7237719097157731e-03]
    disp[23] = [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00]
    disp[24] = [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00]
    disp[25] = [0.0000000000000000e+00, 6.8820225426258763e-03, 5.7237719097157679e-03]
    disp[26] = [0.0000000000000000e+00, 2.0858246606846619e-02, 1.9979840192508393e-02]
    disp[27] = [0.0000000000000000e+00, 4.0788757131876671e-02, 4.9275412797745242e-02]
    disp[28] = [0.0000000000000000e+00, 5.8915274727815797e-02, 8.7562202953283944e-02]
    disp[29] = [0.0000000000000000e+00, 7.3384996509379033e-02, 1.3435935809053373e-01]
    disp[30] = [0.0000000000000000e+00, 8.2067698359605132e-02, 1.8786402047433245e-01]
    disp[31] = [0.0000000000000000e+00, 8.2892902673746896e-02, 2.4458199294873445e-01]
    disp[32] = [0.0000000000000000e+00, 7.4399600828046281e-02, 2.9926324446379732e-01]
    disp[33] = [0.0000000000000000e+00, 5.6395580009698680e-02, 3.4540287030767386e-01]
    disp[34] = [0.0000000000000000e+00, 3.0466654636914378e-02, 3.7643580610070682e-01]
    disp[35] = [0.0000000000000000e+00, 9.5099501391127337e-17, 3.8739937734349739e-01]
    disp[36] = [0.0000000000000000e+00, -3.0466654636914167e-02, 3.7643580610070670e-01]
    disp[37] = [0.0000000000000000e+00, -5.6395580009698416e-02, 3.4540287030767391e-01]
    disp[38] = [0.0000000000000000e+00, -7.4399600828046045e-02, 2.9926324446379748e-01]
    disp[39] = [0.0000000000000000e+00, -8.2892902673746716e-02, 2.4458199294873456e-01]
    disp[40] = [0.0000000000000000e+00, -8.2067698359604951e-02, 1.8786402047433257e-01]
    disp[41] = [0.0000000000000000e+00, -7.3384996509379005e-02, 1.3435935809053393e-01]
    disp[42] = [0.0000000000000000e+00, -5.8915274727815728e-02, 8.7562202953284041e-02]
    disp[43] = [0.0000000000000000e+00, -4.0788757131876643e-02, 4.9275412797745270e-02]
    disp[44] = [0.0000000000000000e+00, -2.0858246606846598e-02, 1.9979840192508411e-02]
    disp[45] = [0.0000000000000000e+00, -6.8820225426258746e-03, 5.7237719097157714e-03]
    disp[46] = [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00]

    rot = {}
    rot[1] = [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00]
    rot[2] = [0.0000000000000000e+00, -1.3778144767941482e-02, 0.0000000000000000e+00]
    rot[3] = [0.0000000000000000e+00, -4.0438826638446002e-02, 0.0000000000000000e+00]
    rot[4] = [0.0000000000000000e+00, -7.5163498973270418e-02, 0.0000000000000000e+00]
    rot[5] = [0.0000000000000000e+00, -1.0384028075821976e-01, 0.0000000000000000e+00]
    rot[6] = [0.0000000000000000e+00, -1.2415897221076697e-01, 0.0000000000000000e+00]
    rot[7] = [0.0000000000000000e+00, -1.3379283713897158e-01, 0.0000000000000000e+00]
    rot[8] = [0.0000000000000000e+00, -1.3082186717067035e-01, 0.0000000000000000e+00]
    rot[9] = [0.0000000000000000e+00, -1.1431243901168503e-01, 0.0000000000000000e+00]
    rot[10] = [0.0000000000000000e+00, -8.4925960278549886e-02, 0.0000000000000000e+00]
    rot[11] = [0.0000000000000000e+00, -4.5310772525036680e-02, 0.0000000000000000e+00]
    rot[12] = [0.0000000000000000e+00, -1.6083666461109323e-17, 0.0000000000000000e+00]
    rot[13] = [0.0000000000000000e+00, 4.5310772525036951e-02, 0.0000000000000000e+00]
    rot[14] = [0.0000000000000000e+00, 8.4925960278549803e-02, 0.0000000000000000e+00]
    rot[15] = [0.0000000000000000e+00, 1.1431243901168507e-01, 0.0000000000000000e+00]
    rot[16] = [0.0000000000000000e+00, 1.3082186717067043e-01, 0.0000000000000000e+00]
    rot[17] = [0.0000000000000000e+00, 1.3379283713897161e-01, 0.0000000000000000e+00]
    rot[18] = [0.0000000000000000e+00, 1.2415897221076699e-01, 0.0000000000000000e+00]
    rot[19] = [0.0000000000000000e+00, 1.0384028075821977e-01, 0.0000000000000000e+00]
    rot[20] = [0.0000000000000000e+00, 7.5163498973270487e-02, 0.0000000000000000e+00]
    rot[21] = [0.0000000000000000e+00, 4.0438826638446036e-02, 0.0000000000000000e+00]
    rot[22] = [0.0000000000000000e+00, 1.3778144767941491e-02, 0.0000000000000000e+00]
    rot[23] = [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00]
    rot[24] = [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00]
    rot[25] = [0.0000000000000000e+00, -1.3778144767941513e-02, 0.0000000000000000e+00]
    rot[26] = [0.0000000000000000e+00, -4.0438826638445939e-02, 0.0000000000000000e+00]
    rot[27] = [0.0000000000000000e+00, -7.5163498973270404e-02, 0.0000000000000000e+00]
    rot[28] = [0.0000000000000000e+00, -1.0384028075821938e-01, 0.0000000000000000e+00]
    rot[29] = [0.0000000000000000e+00, -1.2415897221076683e-01, 0.0000000000000000e+00]
    rot[30] = [0.0000000000000000e+00, -1.3379283713897153e-01, 0.0000000000000000e+00]
    rot[31] = [0.0000000000000000e+00, -1.3082186717067035e-01, 0.0000000000000000e+00]
    rot[32] = [0.0000000000000000e+00, -1.1431243901168499e-01, 0.0000000000000000e+00]
    rot[33] = [0.0000000000000000e+00, -8.4925960278549692e-02, 0.0000000000000000e+00]
    rot[34] = [0.0000000000000000e+00, -4.5310772525036763e-02, 0.0000000000000000e+00]
    rot[35] = [0.0000000000000000e+00, 2.2573003248712812e-16, 0.0000000000000000e+00]
    rot[36] = [0.0000000000000000e+00, 4.5310772525036930e-02, 0.0000000000000000e+00]
    rot[37] = [0.0000000000000000e+00, 8.4925960278550025e-02, 0.0000000000000000e+00]
    rot[38] = [0.0000000000000000e+00, 1.1431243901168534e-01, 0.0000000000000000e+00]
    rot[39] = [0.0000000000000000e+00, 1.3082186717067065e-01, 0.0000000000000000e+00]
    rot[40] = [0.0000000000000000e+00, 1.3379283713897178e-01, 0.0000000000000000e+00]
    rot[41] = [0.0000000000000000e+00, 1.2415897221076705e-01, 0.0000000000000000e+00]
    rot[42] = [0.0000000000000000e+00, 1.0384028075821961e-01, 0.0000000000000000e+00]
    rot[43] = [0.0000000000000000e+00, 7.5163498973270390e-02, 0.0000000000000000e+00]
    rot[44] = [0.0000000000000000e+00, 4.0438826638446015e-02, 0.0000000000000000e+00]
    rot[45] = [0.0000000000000000e+00, 1.3778144767941494e-02, 0.0000000000000000e+00]
    rot[46] = [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00]

    order = 2
    nsampling = [20, 1]
    model1 = simulation_include.Model(E, nu, R, L, h, p, order=order, nsampling=nsampling, plinear_solver=plinear_solver, drill_stiff=drill_stiff)
    model = model1.Run(output=True, disp=disp, rot=rot)

def convergence(n=5, logging=True):
    order = 2
    ny = 1
    nx = 5
    nsamplings = []
    for i in range(0, n):
        nsamplings.append([nx, ny])
        nx *= 2

    ndofs_list = []
    h_list = []
    l2_error_list = []

    ana_sol = analytical_solution.CylindricalShellSolution("/home/hbui/workspace/matlab/FSDT/2025/case2_sol_r=1-3.txt", wscale=R/h)

    if logging:
        ifile = open("convergence.log", "w")
        ifile.write("%-*s%-*s%-*s%-*s%-*s%s\n" % (10, "mesh", 10, "nx", 10, "ny", 10, "ndofs", 20, "l2_error", "h"))

    cnt = 1
    for nsampling in nsamplings:
        model1 = simulation_include.Model(E, nu, R, L, h, p, order=order, nsampling=nsampling, plinear_solver=plinear_solver, drill_stiff=drill_stiff)
        model1.mode = 1
        model = model1.Run(output=False, logging=logging)

        l2_error = simulation_include.ComputeL2Error(model.model_part, ana_sol)

        if logging:
            ifile.write("%-*d%-*d%-*d%-*d%-*e%e\n" % (10, cnt, 10, nsampling[0], 10, nsampling[1], 10, model1.ndofs, 20, l2_error, model1.h))
        ndofs_list.append(model1.ndofs)
        h_list.append(model1.h)
        l2_error_list.append(l2_error)

        cnt += 1

    slope, intercept = np.polyfit(np.log(h_list), np.log(l2_error_list), 1)
    print(f"Convergence rate: {slope}")

    if logging:
        ifile.close()

    return l2_error_list

def tag():
    return "FSDT"

def print_tag():
    print("Tag(s): " + tag())

if __name__ == "__main__":
    if len(sys.argv) > 1:
        globals()[sys.argv[1]]()
    else:
        #
        order = 3
        nsampling = [20, 0]
        #
        # order = 2
        # nsampling = [5, 1]
        #
        model1 = simulation_include.Model(E, nu, R, L, h, p, order=order, nsampling=nsampling, plinear_solver=plinear_solver, drill_stiff=drill_stiff)
        model1.mode = 1
        model = model1.Run(output=True)

        # ana_sol = analytical_solution.CylindricalShellSolution("/home/buih/workspace/matlab/FSDT/case2_sol_r=1-2.txt")
        # ana_sol = analytical_solution.CylindricalShellSolution("/home/hbui/workspace/matlab/FSDT/2025/case2_sol_r=1.txt")
        # ana_sol = analytical_solution.CylindricalShellSolution("/home/hbui/workspace/matlab/FSDT/2025/case2_sol_r=1-2.txt")
        ana_sol = analytical_solution.CylindricalShellSolution("/home/hbui/workspace/matlab/FSDT/2025/case2_sol_r=1-3.txt")
        l2_error = simulation_include.ComputeL2Error(model.model_part, ana_sol)
        print("Mesh size: %.10e" % (model1.h))
        print("Global displacement (L2) error: %.10e" % (l2_error))
